<h2>Convert Comments to Annotations</h2>
<div id="status">Waiting for settings...</div>
<button id="convert" disabled>Convert</button>
<pre id="log" style="font-size: 10px; color: #666;"></pre>

<script>
  let figmaToken = '';
  let currentFileKey = '';

  // Notify code that UI is ready
  window.onload = () => {
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
  }

  window.onmessage = (event) => {
    const msg = event.data.pluginMessage;
    if (msg.type === 'settings') {
      figmaToken = msg.token;
      currentFileKey = msg.fileKey;

      const hasToken = !!figmaToken;
      const hasKey = !!currentFileKey && currentFileKey !== 'undefined';

      if (hasKey && hasToken) {
        document.getElementById('status').innerText = 'Ready to convert';
        document.getElementById('convert').disabled = false;
      } else {
        document.getElementById('status').innerText = 'Missing ' + (!hasToken ? 'Token ' : '') + (!hasKey ? 'File Key' : '');
      }

      log(`Settings received. Token: ${hasToken ? 'OK' : 'MISSING'}, Key: ${currentFileKey}`);
    }
  };

  document.getElementById('convert').onclick = async () => {
    if (!figmaToken || !currentFileKey || currentFileKey === 'undefined') {
      log('Error: Missing token or file key');
      return;
    }

    document.getElementById('convert').disabled = true;
    document.getElementById('status').innerText = 'Fetching comments...';

    try {
      const response = await fetch(`https://api.figma.com/v1/files/${currentFileKey}/comments`, {
        headers: {
          'X-Figma-Token': figmaToken
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      log(`Fetched ${data.comments ? data.comments.length : 0} comments`);

      parent.postMessage({
        pluginMessage: {
          type: 'create-annotations',
          comments: data.comments
        }
      }, '*');

      document.getElementById('status').innerText = 'Processing in Figma...';

    } catch (e) {
      log('Error fetching comments: ' + e.message);
      document.getElementById('status').innerText = 'Error';
      document.getElementById('convert').disabled = false;
    }
  }

  function log(msg) {
    const el = document.getElementById('log');
    el.innerText += msg + '\n';
    console.log(msg);
  }
</script>